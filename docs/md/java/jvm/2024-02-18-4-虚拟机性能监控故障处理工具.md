---
title: 第四章、虚拟机性能监控、故障处理工具
---
# 第四章、虚拟机性能监控、故障处理工具

## 4.1 概述

## 4.2 基础故障处理工具

JDK的bin目录下有各种工具，除了编译和运行Java程序外，打包、部署、签名、调试、监控、运维等各种场景都可能会用到它们。

### 4.2.1 jps虚拟机进程状况工具

可以列出正在运行的虚拟机进程，并显示虚拟机执行主类名称以及这些进程的本地虚拟机唯一ID(LVMID)

而其他命令正是依赖于LVMID来确定是哪个虚拟机进程

```shell
命令格式：
jps [options] [hostid]
```

options参数表：

| 选项 | 作用                                                   |
| ---- | ------------------------------------------------------ |
| -q   | 只输出LVMID,省略主类的名称                             |
| -m   | 输出虚拟机进程启动时传递给主类main()函数的参数         |
| -l   | 输出主类的全名，如果进程执行的时JAR包，则输出JAR包路径 |
| -v   | 输出虚拟机进程启动时的JVM参数                          |

jps还可以通过RMI协议查询开启了RMI服务的远程虚拟机进程状态，参数hostid为RMI注册表中注册的主机名

### 4.2.2 jstat虚拟机统计信息监视工具

用于监视虚拟机各种运行状态信息的命令行工具，显示本地或远程虚拟机进程中的类加载、内存、垃圾收集、即时编译等运行时数据，在没有GUI图形界面、只提供了纯文本控制台环境的服务器上，它将是运行期定位虚拟机性能问题的常用工具。

```sh
命令格式：
jstat [option vmid [interval[s|ms] [count]]]
其中vmid，如果是本地虚拟机线程，vmid就是lvmid；如果是远程虚拟机线程，则为：
[protocol:][//]lvmid[@hostname[:port]/servername]
```

option参数表：

| 选项              | 作用                                                         |
| ----------------- | ------------------------------------------------------------ |
| -class            | 监视类加载、卸载数量、总空间以及类装载所耗费的时间           |
| -gc               | 监视Java堆状况，包括Eden区、2个Survivor区、老年代、永久代等的容量，已用空间、垃圾收集时间合计等信息 |
| -gccapacity       | 监视内容和-gc基本相同，但输出主要关注Java堆各个区域使用到的最大、最小空间 |
| -gcutil           | 监视内容和-gc基本相同，但输出主要关注已使用空间占总空间的百分比 |
| -gccause          | 与-gcutil功能一样，但是会额外输出导致上一次垃圾收集产生的原因 |
| -gcnew            | 监视新生代垃圾收集状况                                       |
| -gcnewcapacity    | 监视内容和-gcnew基本相同，输出主要关注使用到的最大、最小空间 |
| -gcold            | 监视老年代垃圾收集状况                                       |
| -gcoldcapacity    | 监视内容和-gcold基本相同，输出主要关注使用到的最大、最小空间 |
| -gcpermcapacity   | 监视永久代使用的最大、最小空间                               |
| -compiler         | 输出即时编译器编译过的方法、耗时等信息                       |
| -printcompilation | 输出已经被即时编译的方法                                     |

interval参数代表查询间隔，如100(ms可省略，默认为毫秒)即每隔100毫秒查询一次，5s即每隔5秒查询一次

count参数代表查询次数，如20代表一共查询20次

### 4.2.3 jinfo配置信息工具

实时查看和调整虚拟机各项参数

```shell
命令格式：
jinfo [option] pid
```

option参数表，如果不指定option，则输出全部参数

| 选项              | 作用                         |
| ----------------- | ---------------------------- |
| -sysprops         | 输出虚拟机的全部的系统属性   |
| -flags            | 输出虚拟机曾经赋过值的参数值 |
| -flags <具体参数> | 输出虚拟机具体参数的值       |

关于调整虚拟机参数，其修改能力非常有限(只有被标记 manageable的flag可以被实时修改)，修改方式：

- 布尔类型: `jinfo -flags +-参数 pid`
- 非布尔类型: `jinfo -flags 参数名=参数值 pid`

### 4.2.4 jamp内存映像工具

获取堆转储快照、查询finalize执行队列、Java堆和方法区的详细信息，如空间使用率、当前用的是哪种收集器等

```shell
命令格式：
jmap [option] vmid
```

option参数表：

| 选项           | 作用                                                         |
| -------------- | ------------------------------------------------------------ |
| -dump          | 生成Java堆转储快照，格式为-dump:[live,]format=b,file=filename。其中live子参数说明是否只dump出存活的对象 |
| -finalizerinfo | 显示在F-Queue中等待Finalizer线程执行finalize方法的对象       |
| -heap          | 显示Java堆详细信息，如使用哪种回收器、参数配置、分代状况等   |
| -histo         | 显示堆中对象统计信息，包括类、实例数量、合计容量             |
| -permstat      | 以ClassLoader为统计口径显示永久代内存状态                    |
| -F             | 当虚拟机进程对-dump选项没有响应时，可使用这个选项强制生成dump快照 |

### 4.2.5 jhat虚拟机堆转储快照分析工具

jhat与jmap搭配使用，来分析生成的堆转储快照。然而一般不会用jhat来分析，一是因为不会直接在生产环境分析快照，往往会拷贝到开发机器上。那么就没必要使用功能简陋的jhat，完全可以用更强大专业的分析工具来分析快照

### 4.2.6 jstack堆栈跟踪工具

生成虚拟机当前时刻的线程快照，即每一条线程正在执行的方法堆栈的集合。生成线程快照的目的通常是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间挂起等，都是导致线程长时间停顿的常见原因。

```shell
命令格式：
jstack [option] vmid
```

option参数表：

| 选项 | 作用                                       |
| ---- | ------------------------------------------ |
| -F   | 当正常输出请求不被响应时，强制输出线程堆栈 |
| -l   | 除堆栈外，显示关于锁的附加信息             |
| -m   | 如果调用本地方法的话，可以显示C/C++的堆栈  |

JDK5起，java.lang.Thread类新增了一个getAllStackTraces()方法用于获取虚拟机中所有线程的StackTraceElement对象，通过这个方法可以简单实现jstack大部分功能

### 4.2.7 基础工具总结

基础工具表：

| 名称         | 主要作用                                                |
| ------------ | ------------------------------------------------------- |
| appletviewer | 在不使用Web浏览器的情况下运行和调试Applet，JDK11移除    |
| extcheck     | 检查JAR冲突的工具，JDK9移除                             |
| jar          | 创建和管理JAR文件                                       |
| java         | Java运行工具，用于运行Class文件或JAR文件                |
| javac        | 用于Java编程语言的编译器                                |
| javadoc      | Java的API文档生成器                                     |
| javah        | C语言头文件和Stub函数生成器，用于编写JNI方法            |
| javap        | Java字节码分析工具                                      |
| jlink        | 将Module和他的依赖打包成一个运行时镜像文件              |
| jdb          | 基于JPDA协议的调试器，以类似于GDB的方式进行调试Java代码 |
| jdeps        | Java类依赖性分析器                                      |
| jdeprscan    | 用于搜索JAR包中使用了`deprecated`的类，从JDK9开始提供   |

安全工具表：用于程序签名、设置安全测试等

| 名称       | 主要作用                                                     |
| ---------- | ------------------------------------------------------------ |
| keytool    | 管理密钥库和证书。主要用于获取或缓存Kerberos协议的票据授权票据。允许用户查看本地凭据缓存或密钥表中的条目 |
| jarsigner  | 生成并验证JAR签名                                            |
| policytool | 管理策略文件的GUI工具，用于管理用户策略文件(.java.policy),JDK10移除 |

国际化：用于创建本地语言文件

| 名称         | 主要作用                                                     |
| ------------ | ------------------------------------------------------------ |
| native2ascii | 本地编码到ASCII编码的转换器，用于任意受支持的字符编码和与之对应的ASCII编码和Unicode转义之间的相互转换 |

远程方法调用：用于跨Web或网络的服务交互

| 名称        | 主要作用                                                     |
| ----------- | ------------------------------------------------------------ |
| rmic        | Java RMI编译器，为使用JRMP或IIOP协议的远程对象生成Stub、Skeletion和Tie类，也用于生成OMG IDL |
| rmiregistry | 远程对象注册表服务，用于在当前主机的指定端口上创建并启动一个远程对象注册表 |
| rmid        | 启动激活系统守护进程，允许在虚拟机中注册或激活对象           |
| serialver   | 生成并返回指定类的序列化版本ID                               |

Java IDL与RMI-IIOP，在JDK11中结束了十余年的CORBA支持，这些工具不再提供

| 名称       | 主要作用                                                     |
| ---------- | ------------------------------------------------------------ |
| tnameserv  | 提供对命名服务的访问                                         |
| idlj       | IDL转Java编译器，生成映射OMG IDL接口的Java源文件，并启用以Java编程语言编写的使用CORBA功能的应用程序的Java源文件 |
| orbd       | 对象请求代理守护进程，提供从客户端查找和调用CORBA环境服务端上的持久化对象的功能 |
| servertool | 为应用程序注册、注销、启动和关闭服务器提供易用的接口         |

部署工具：用于程序打包、发布和部署

| 名称         | 主要作用                                            |
| ------------ | --------------------------------------------------- |
| javapackager | 打包、签名Java和JavaFX应用程序，JDK11移除           |
| pack200      | 使用Java GZIP压缩器将JAR文件转化为压缩的Pack200文件 |
| unpack200    | 将Pack200生成的打包文件解压提取为JAR文件            |

Java Web Start

| 名称   | 主要作用                                          |
| ------ | ------------------------------------------------- |
| javaws | 启动Java Web Start并设置各种选项的工具，JDK11移除 |

性能监控和故障处理：用于监控分析Java虚拟机运行信息，排查问题

| 名称      | 主要作用                                                     |
| --------- | ------------------------------------------------------------ |
| jps       | 显示指定系统内所有的HotSpot虚拟机进程                        |
| jstat     | 收集HotSpot虚拟机各方面的运行数据                            |
| jstatd    | jstat的守护程序，启动一个RMI服务器应用程序，用于监视测试的HotSpot虚拟机的创建和终止，并提供一个界面，允许远程监控工具附加到在本地系统运行的虚拟机，JDK9集成到了jhsdb中 |
| jinfo     | 显示虚拟机配置信息，JDK9集成到了jhsdb中                      |
| jmap      | 生成虚拟机的内存转储快照，JDK9集成到了jhsdb中                |
| jhat      | 分析堆转储快照，JDK9被jhsdb代替                              |
| jstack    | 显示虚拟机的线程快照，JDK9集成到了jhsdb中                    |
| jhsdb     | 基于Serviceability Agent的HotSpot进程调试器，从JDK9开始提供  |
| jsadebugd | 适用于Java的可维护性代理调试守护程序，主要用于附加到指定的Java进程、核心文件或充当一个调试服务器 |
| jcmd      | 虚拟机诊断命令工具，将诊断命令请求发送到正在运行的Java虚拟机，JDK7开始提供 |
| jconsole  | 监控Java虚拟机的使用JMX规范的图形工具，监控本地或远程Java虚拟机，还可以监控和管理应用程序 |
| jmc       | 监控和管理Java应用程序的工具，而不会引入与这些工具相关联的性能开销 |
| jvisualvm | 图形化工具，可在Java虚拟机中运行时提供有关基于Java技术的应用程序的详细信息。Java VisualVM提供内存和CPU分析、堆转储分析、内存泄漏检测、MBean访问和垃圾收集。JDK6Update7开始提供，JDK9不再打包入JDK，但仍保持更新可独立下载 |

WebService工具：与CORBA一起在JDK11中移除

| 名称      | 主要作用                                                     |
| --------- | ------------------------------------------------------------ |
| schemagen | 用于XML绑定的Schema生成器，用于生成XML Schema文件            |
| wsgen     | XML Web Service 2.0的Java API，生成用于JAX-WS Web Service的JAX-WS便携式产物 |
| wsimport  | XML Web Service 2.0的Java API，主要用于跟据服务端发布的WSDL文件生成客户端 |
| xjc       | 主要用于跟据XML Schema文件生成对应的Java类                   |

REPL和脚本工具

| 名称       | 主要作用                                                     |
| ---------- | ------------------------------------------------------------ |
| jshell     | 基于Java的Shell REPL交互工具                                 |
| jjs        | 对Nashorn引擎的调用入口，Nashorn是基于Java实现的一个轻量级高性能JavaScript运行环境 |
| jrunscript | Java命令行脚本外壳工具，主要用于解释执行JavaScript、Groovy、Ruby等脚本语言 |

## 4.3 可视化故障处理工具

### 4.3.1 JHSDB基于服务性代理的调试工具

### 4.3.2 JConsole监控与管理控制台

### 4.3.3 VisualVM多合-故障处理工具

### 4.3.4 Java Mission Control可持续在线的监控工具

::: tip 说明

因为生产环境基本都部署在Linux服务器上，不具备可视化能力；而往往生产环境和本地的网段是不通的，因此可视化工具往往派不上用场。通常还需要依赖其他工具做出可视化的监控看板。

所以这一节的内容完全可以略过

:::

## 4.4 HotSpot虚拟机插件及工具

HotSpot有不少虚拟机插件和辅助工具：

- Ideal Graph Visualizer，用于可视化展示C2即时编译器是如何将字节码转化为理想图，然后转化为机器码的
- Client Compiler Visualizer，用于查看C1即时编译器生成高级中间表示，转换成低级中间表示和做物理寄存器分配的过程
- MakeDeps，帮助处理HotSpot的编译依赖的工具
- Project Creator，帮厨生成Visual Studio的.project文件的工具
- LogCompilation，将-XX:+LogCompilation输出的日志整理成更容易阅读的格式工具
- HSDIS，即时编译器的反汇编插件

